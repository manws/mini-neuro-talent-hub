<wxs module="utils">
var isOptionSelected = function(formData, fieldCode, optionCode) {
  if (!formData || !formData[fieldCode]) {
    return false;
  }
  var selectedValues = formData[fieldCode].selectedValues;
  if (!selectedValues) {
    return false;
  }
  return selectedValues.indexOf(optionCode) !== -1;
};

module.exports.isOptionSelected = isOptionSelected;
</wxs>

<view class="flex-style-column container">
  <view class="flex-style-column header-layout">
    <view style="width: 100%;">
      <navbar></navbar>
      <toolbar>
        <view class="flex-style-base toolbar-layout">
          <image class="back-icon" image-fit="aspectFit" src="../../assets/arrow-white.png" bind:tap="back"></image>
          <text class="title-text">{{title}}</text>
        </view>
      </toolbar>
    </view>
  </view>
  
  <swiper current="{{position}}" bindchange="swipterChange" class="swiper-view">
    <swiper-item wx:for="{{scoreList}}" wx:key="index" class="swiper-item-view">
      <view class="flex-style-column" style="height: 100%;">
        <text class="title">{{index + 1}}. {{item.level2Name}}</text>
        
        <scroll-view class="scroll-view" scroll-y bindscroll="bindScroll">
          <!-- 如果是分组，显示所有子项 -->
          <view wx:if="{{item.isGroup}}" class="group-container">
            <view wx:for="{{item.groupChildren}}" wx:key="fieldCode" wx:for-item="subItem" wx:for-index="subIndex" wx:if="{{subItem.isVisible !== false}}" class="sub-item">
              <text class="sub-title">{{item.fieldCode}}.{{subIndex + 1}} {{subItem.level2Name}}</text>
              
              <!-- 单选题 -->
              <view wx:if="{{subItem.type === 'single_choice'}}" class="form-item">
                <radio-group bindchange="handleRadioChange" data-fieldcode="{{subItem.level2Code}}" data-datakey="{{subItem.fieldCode}}" data-radiotype="main">
                  <label wx:for="{{subItem.codegroup}}" wx:key="code" wx:for-item="option" class="flex-style-base radio-item">
                    <radio value="{{option.code}}" checked="{{formData[subItem.level2Code] && formData[subItem.level2Code].selectedValue === option.code}}"/>
                    <text class="radio-text">{{option.label}}</text>
                  </label>
                </radio-group>
                
                <!-- 新格式：single_choice + text subField -->
                <view wx:if="{{subItem.subField && subItem.subField.type === 'text' && subItem.showSubFieldDescription}}" class="description-input">
                  <text class="description-label">{{subItem.subField.title}}</text>
                  <textarea 
                    value="{{(formData[subItem.level2Code] && formData[subItem.level2Code].description) || ''}}" 
                    bindinput="handleInput" 
                    data-fieldcode="{{subItem.level2Code}}" 
                    data-datakey="{{subItem.subField.fieldCode}}"
                    data-inputtype="description"
                    class="textarea" 
                    placeholder="请输入描述" 
                    placeholder-style="color:#D9D9D9;"
                    auto-height="{{true}}"
                    maxlength="-1"
                  />
                </view>
              </view>

              <!-- 多选题 -->
              <view wx:if="{{subItem.type === 'multiple_choice'}}" class="form-item">
                <checkbox-group bindchange="handleCheckboxChange" data-fieldcode="{{subItem.level2Code}}" data-datakey="{{subItem.fieldCode}}">
                  <label wx:for="{{subItem.codegroup}}" wx:key="code" wx:for-item="option" class="checkbox-item">
                    <checkbox value="{{option.code}}" checked="{{utils.isOptionSelected(formData, subItem.level2Code, option.code)}}"/>
                    <text class="checkbox-text">{{option.label}}</text>
                  </label>
                </checkbox-group>
              </view>

              <!-- 数字输入 -->
              <view wx:if="{{subItem.type === 'number'}}" class="form-item">
                <view class="flex-style-base input-layout">
                  <input 
                    value="{{formData[subItem.level2Code] && formData[subItem.level2Code].value || ''}}" 
                    bindinput="handleInput" 
                    data-fieldcode="{{subItem.level2Code}}" 
                    data-datakey="{{subItem.fieldCode}}"
                    class="input" 
                    type="number" 
                    placeholder="请输入数字" 
                    placeholder-style="color:#D9D9D9;" 
                  />
                </view>
              </view>

              <!-- 文本输入 -->
              <view wx:if="{{subItem.type === 'text'}}" class="form-item">
                <view class="textarea-layout">
                  <textarea 
                    value="{{formData[subItem.level2Code] && formData[subItem.level2Code].value}}" 
                    bindinput="handleInput" 
                    data-fieldcode="{{subItem.level2Code}}" 
                    data-datakey="{{subItem.fieldCode}}"
                    class="textarea" 
                    placeholder="请输入内容" 
                    placeholder-style="color:#D9D9D9;"
                    auto-height="{{true}}"
                    maxlength="-1"
                  />
                </view>
                
                <!-- 新格式：text + single_choice subField -->
                <view wx:if="{{subItem.subField && subItem.subField.type === 'single_choice'}}" class="radio-section">
                  <text class="radio-title">{{subItem.subField.title}}</text>
                  <radio-group bindchange="handleRadioChange" data-fieldcode="{{subItem.level2Code}}" data-datakey="{{subItem.subField.fieldCode}}" data-radiotype="sub">
                    <label wx:for="{{subItem.subField.codegroup}}" wx:key="code" wx:for-item="option" class="radio-item">
                      <radio value="{{option.code}}" checked="{{formData[subItem.level2Code] && formData[subItem.level2Code].subSelectedValue === option.code}}"/>
                      <text class="radio-text">{{option.label}}</text>
                    </label>
                  </radio-group>
                </view>
              </view>

              <!-- 文本输入+单选 -->
              <view wx:if="{{subItem.type === 'text_with_radio'}}" class="form-item">
                <view class="textarea-layout">
                  <textarea 
                    value="{{formData[subItem.level2Code] && formData[subItem.level2Code].value}}" 
                    bindinput="handleInput" 
                    data-fieldcode="{{subItem.level2Code}}" 
                    data-datakey="{{subItem.textDataKey}}"
                    class="textarea" 
                    placeholder="{{subItem.textFieldPlaceholder || '请输入内容'}}" 
                    placeholder-style="color:#D9D9D9;"
                    auto-height="{{true}}"
                    maxlength="-1"
                  />
                </view>
                <view class="radio-section">
                  <text class="radio-title">{{subItem.radioTitle}}</text>
                  <radio-group bindchange="handleRadioChange" data-fieldcode="{{subItem.level2Code}}" data-datakey="{{subItem.radioDataKey}}" data-radiotype="sub">
                    <label wx:for="{{subItem.radioCodes}}" wx:key="code" wx:for-item="option" class="radio-item">
                      <radio value="{{option.code}}" checked="{{formData[subItem.level2Code] && formData[subItem.level2Code].subSelectedValue === option.code}}"/>
                      <text class="radio-text">{{option.label}}</text>
                    </label>
                  </radio-group>
                </view>
              </view>

              <!-- 单选+描述输入 -->
              <view wx:if="{{subItem.type === 'single_choice_with_text'}}" class="form-item">
                <radio-group bindchange="handleRadioChange" data-fieldcode="{{subItem.level2Code}}" data-datakey="{{subItem.mainDataKey}}" data-radiotype="main">
                  <label wx:for="{{subItem.codegroup}}" wx:key="code" wx:for-item="option" class="radio-item">
                    <radio value="{{option.code}}" checked="{{formData[subItem.level2Code] && formData[subItem.level2Code].selectedValue === option.code}}"/>
                    <text class="radio-text">{{option.label}}</text>
                  </label>
                </radio-group>
                
                <!-- subField 描述输入框 -->
              </view>
            </view>
          </view>

          <!-- 如果不是分组，直接显示单个项目 -->
          <view wx:if="{{!item.isGroup}}" class="single-item">
            <!-- 单选题 -->
            <view wx:if="{{item.type === 'single_choice'}}" class="form-item">
              <radio-group bindchange="handleRadioChange" data-fieldcode="{{item.level2Code}}" data-datakey="{{item.fieldCode}}" data-radiotype="main">
                <label wx:for="{{item.codegroup}}" wx:key="code" wx:for-item="option" class="radio-item">
                  <radio value="{{option.code}}" checked="{{formData[item.level2Code] && formData[item.level2Code].selectedValue === option.code}}"/>
                  <text class="radio-text">{{option.label}}</text>
                </label>
              </radio-group>
              
              <!-- 新格式：single_choice + text subField -->
              <view wx:if="{{item.subField && item.subField.type === 'text' && item.showSubFieldDescription}}" class="description-input">
                <text class="description-label">{{item.subField.title}}</text>
                <textarea 
                  value="{{(formData[item.level2Code] && formData[item.level2Code].description) || ''}}" 
                  bindinput="handleInput" 
                  data-fieldcode="{{item.level2Code}}" 
                  data-datakey="{{item.subField.fieldCode}}"
                  data-inputtype="description"
                  class="textarea" 
                  placeholder="请输入描述" 
                  placeholder-style="color:#D9D9D9;"
                  auto-height="{{true}}"
                  maxlength="-1"
                />
              </view>
            </view>

            <!-- 多选题 -->
            <view wx:if="{{item.type === 'multiple_choice'}}" class="form-item">
              <checkbox-group bindchange="handleCheckboxChange" data-fieldcode="{{item.level2Code}}" data-datakey="{{item.fieldCode}}">
                <label wx:for="{{item.codegroup}}" wx:key="code" wx:for-item="option" class="checkbox-item">
                  <checkbox value="{{option.code}}" checked="{{utils.isOptionSelected(formData, item.level2Code, option.code)}}"/>
                  <text class="checkbox-text">{{option.label}}</text>
                </label>
              </checkbox-group>
            </view>

            <!-- 数字输入 -->
            <view wx:if="{{item.type === 'number'}}" class="form-item">
              <view class="flex-style-base input-layout">
                <input 
                  value="{{formData[item.level2Code] && formData[item.level2Code].value || ''}}" 
                  bindinput="handleInput" 
                  data-fieldcode="{{item.level2Code}}" 
                  data-datakey="{{item.fieldCode}}"
                  class="input" 
                  type="number" 
                  placeholder="请输入数字" 
                  placeholder-style="color:#D9D9D9;" 
                />
              </view>
            </view>

            <!-- 文本输入 -->
            <view wx:if="{{item.type === 'text'}}" class="form-item">
              <view class="textarea-layout">
                <textarea 
                  value="{{formData[item.level2Code] && formData[item.level2Code].value}}" 
                  bindinput="handleInput" 
                  data-fieldcode="{{item.level2Code}}" 
                  data-datakey="{{item.fieldCode}}"
                  class="textarea" 
                  placeholder="请输入内容" 
                  placeholder-style="color:#D9D9D9;"
                  auto-height="{{true}}"
                  maxlength="-1"
                />
              </view>
              
              <!-- 新格式：text + single_choice subField -->
              <view wx:if="{{item.subField && item.subField.type === 'single_choice'}}" class="radio-section">
                <text class="radio-title">{{item.subField.title}}</text>
                <radio-group bindchange="handleRadioChange" data-fieldcode="{{item.level2Code}}" data-datakey="{{item.subField.fieldCode}}" data-radiotype="sub">
                  <label wx:for="{{item.subField.codegroup}}" wx:key="code" wx:for-item="option" class="radio-item">
                    <radio value="{{option.code}}" checked="{{formData[item.level2Code] && formData[item.level2Code].subSelectedValue === option.code}}"/>
                    <text class="radio-text">{{option.label}}</text>
                  </label>
                </radio-group>
              </view>
            </view>

            <!-- 单选+描述输入 -->
            <view wx:if="{{item.type === 'single_choice_with_text'}}" class="form-item">
              <radio-group bindchange="handleRadioChange" data-fieldcode="{{item.level2Code}}" data-datakey="{{item.mainDataKey}}" data-radiotype="main">
                <label wx:for="{{item.codegroup}}" wx:key="code" wx:for-item="option" class="radio-item">
                  <radio value="{{option.code}}" checked="{{formData[item.level2Code] && formData[item.level2Code].selectedValue === option.code}}"/>
                  <text class="radio-text">{{option.label}}</text>
                </label>
              </radio-group>
              
              <!-- subField 描述输入框 -->
            </view>
          </view>

          <!-- 评分标准显示 -->
          <text wx:if="{{item.level2Std}}" class="tips">评分标准：{{item.level2Std}}</text>
          
          <!-- 图片上传 -->
          <view wx:if="{{item.isUploadImg == 1}}" class="flex-style-base" style="margin-top: 48rpx;justify-content: flex-start;">
            <text class="upload-img">上传图片</text>
            <text class="upload-tips">（支持PNG、JPG格式，图片小于2M）</text>
          </view>
          <view style="height: 24rpx;"></view>
          <van-uploader wx:if="{{item.isUploadImg == 1}}" accept="image" file-list="{{ fileList }}" image-fit="aspectFill" preview-size="196rpx" deletable="{{ true }}" bind:after-read="fileAfterRead" bind:delete="fileDeleteImg" multiple="{{true}}" max-size="{{1048576 * 20}}" max-count="9">
          </van-uploader>
        </scroll-view>
      </view>
    </swiper-item>
  </swiper>
  
  <view style="width: 100%;height: 80rpx;" class="flex-style-base">
    <text style="color: #AFAFAF;">{{position + 1}}/{{fieldLength}}</text>
  </view>

  <view class="flex-style-base op-group-layout">
    <text wx:if="{{position == 0}}" class="flex-style-base op-text-zero">上一项</text>
    <text wx:if="{{position > 0}}" class="flex-style-base op-text-pre" bindtap="previous">上一项</text>
    <text wx:if="{{position < fieldLength - 1 && isCurrentPageComplete}}" class="flex-style-base op-text" bindtap="next">下一项</text>
    <text wx:if="{{position < fieldLength - 1 && !isCurrentPageComplete}}" class="flex-style-base op-text-disabled">下一项</text>
    <text wx:if="{{position == fieldLength - 1 && isCurrentPageComplete}}" class="flex-style-base op-text" bindtap="submit">提交</text>
    <text wx:if="{{position == fieldLength - 1 && !isCurrentPageComplete}}" class="flex-style-base op-text-disabled">提交</text>
  </view>
</view>